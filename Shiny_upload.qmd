---
title: "Shiny"
author: "Gop Arop"
format: 
  html:
    embed-resources: true
    warning: false
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(shiny)
library(glue)
```

```{r}
seasons_choice <- paste0(substr(seq(2023, 2000), 1, 4), "-", substr(seq(2024, 2001), 3, 4))
```

```{r}
ui <- fluidPage(
  tabsetPanel(
    tabPanel("Shot Chart", fluid = TRUE,
             sidebarLayout(
               sidebarPanel(
                 selectInput("player_sel", label = "Select a Player", choices = NULL),
                 selectInput("season_sel", label = "Select a Season", choices = seasons_choice)
               ),
               mainPanel(plotOutput("shot_chart", height = "580px"), tableOutput("sum_stats"))
             )
    ),
    tabPanel("Quad Plot", fluid = TRUE, 
             sidebarLayout(
               sidebarPanel(
                 radioButtons("xvar_sel", label = "Select a Variable for X-Axis", choices = c(2,3)),
                 radioButtons("yvar_sel", label = "Select a Variable for Y-Axis", choices = c(1,2))
               ), 
               mainPanel()))
  )
)

server <- function(input, output, session) {
  
  data_react <- reactive({
    shot_data <-  tibble(nba_shotchartdetail(league_id = '00', player_id = input$player_sel, season = input$season_sel))
    
    data <- shot_data[[1]][[1]] |> 
      mutate(LOC_X = as.numeric(LOC_X), LOC_Y = as.numeric(LOC_Y), xx = LOC_X/10, yy = LOC_Y/10 - 41.75) |> 
      rename(shot_distance = SHOT_DISTANCE, original_x = LOC_X, original_y = LOC_Y, converted_y = yy, converted_x = xx)  |> 
  filter(EVENT_TYPE == "Made Shot")
  })
  
  observeEvent(input$season_sel, {
    players_df <-  nba_leagueleaders(season = input$season_sel, stat_category = "PTS", per_mode = "PerGame")
    
    players_lead <- players_df[["LeagueLeaders"]] |>
      mutate(PTS = as.numeric(PTS))
    
    players_top20 <- players_lead |>
      arrange(desc(PTS)) |>
      slice(1:20)
    
    player_choices <- players_top20 |> distinct(PLAYER_ID) |> pull(PLAYER_ID) 
    
    updateSelectInput(inputId = "player_sel", choices = player_choices)
  })
  
  
  output$shot_chart <- renderPlot({
    chart <- ggplot(data = data_react(), aes(x = converted_x,y = converted_y)) + geom_point() + coord_fixed() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_rect(fill = "white"), axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank())
    
  drawNBAcourt(chart, full = TRUE)
    
  })
  
  output$sum_stats <- renderTable({
    data_react() |> 
      mutate(ind_2s = if_else(SHOT_TYPE == "2PT Field Goal", 1, 0),
             ind_3s = if_else(SHOT_TYPE == "3PT Field Goal", 1, 0)) |>
      summarise("Proportion of 2s" = sum(ind_2s) / n(), "Proportion of 3s" = sum(ind_3s) / n())
  })
  

}

shinyApp(ui, server)
```









